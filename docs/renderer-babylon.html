<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js vr - panorama with depth</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
		<link type="text/css" rel="stylesheet" href="main.css">
        <style>
            #progressBar {
                width: 500px;
                height: 24px;
                position: absolute;
                left: 50%;
                top: 10px;
                margin-left: -250px;
            }

			html, body {
                overflow: hidden;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            #renderCanvas {
                width: 100%;
                height: 100%;
                touch-action: none;
            }
            
            #canvasZone {
                width: 100%;
                height: 100%;
            }
        </style>
	</head>

	<body>
        <progress value="0" max="100" id="progressBar"></progress>
        <script src="https://cdn.babylonjs.com/babylon.js"></script>
		<script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>

		<div id="canvasZone"><canvas id="renderCanvas"></canvas></div>

		<script>
        	var canvas = document.getElementById("renderCanvas");

			var startRenderLoop = function (engine, canvas) {
				engine.runRenderLoop(function () {
					if (sceneToRender && sceneToRender.activeCamera) {
						sceneToRender.render();
					}
				});
			}

			var engine = null;
			var scene = null;
			var sceneToRender = null;
			var createDefaultEngine = async function() { return new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true}); };
			var createScene = async function () {
				var scene = new BABYLON.Scene(engine);
				// var camera = new BABYLON.FreeCamera('camera1', new BABYLON.Vector3(0, 2, 0), scene);
				// camera.setTarget(new BABYLON.Vector3(0,2,1));
				// camera.attachControl(canvas, false);
				// Create a basic light, aiming 0, 1, 0 - meaning, to the sky
				// var light = new BABYLON.HemisphericLight('light1', new BABYLON.Vector3(0, 1, 0), scene);
				// Create a built-in "sphere" shape using the SphereBuilder
				// var sphere = BABYLON.MeshBuilder.CreateSphere('sphere1', {segments: 16, diameter: 2, sideOrientation: BABYLON.Mesh.FRONTSIDE}, scene);
				// Move the sphere upward 1/2 of its height
				// sphere.position.y = 1;
				// Create a built-in "ground" shape;
				// var ground = BABYLON.MeshBuilder.CreateGround("ground1", { width: 6, height: 6, subdivisions: 2, updatable: false }, scene);
				// Return the created scene

				// var url = "https://models.babylonjs.com/CornellBox/";
				// var name = "cornellBox.glb"
				var url = "https://3d-pano-inpainting.s3.us-west-2.amazonaws.com/";
				var name = "basel_martinsgasse_2k.glb";
				BABYLON.SceneLoader.LoadAssetContainer(url,name,scene,
					function (container) {
						console.log(container);

						container.materials[0].unlit = true;
						container.addAllToScene();

						// scene.createDefaultCameraOrLight(true, true, true);

						var camera = new BABYLON.FreeCamera('camera1', new BABYLON.Vector3(0, 2, 0), scene);
						camera.setTarget(new BABYLON.Vector3(0,2,1));
						camera.attachControl(canvas, false);

						var light = new BABYLON.HemisphericLight('light1', new BABYLON.Vector3(0, 1, 0), scene);

						scene.createDefaultEnvironment();

						scene.createOrUpdateSelectionOctree();
						const xr = scene.createDefaultXRExperienceAsync();
						progressBar.style.display = 'none'
					},
					function (progress) {
						if ( progress.lengthComputable ) {
							var percentComplete = (progress.loaded / progress.total) * 100;
							progressBar.value = percentComplete;
							progressBar.style.display = 'block';
						}
					}
				);
				return scene;
			}

			window.initFunction = async function() {
				window.engine = await createDefaultEngine();
				if (!engine) throw 'engine should not be null.';
				startRenderLoop(engine, canvas);
				window.scene = createScene();
			};
			initFunction().then(() => {scene.then(returnedScene => { sceneToRender = returnedScene; });});

			// the canvas/window resize event handler
			window.addEventListener('resize', function(){
				engine.resize();
			});

			// window.setInterval(
			// 	function(){
			// 		console.log(engine.getFps());
			// 	}, 1000
			// );

		</script>
	</body>
</html>
